name: Deploy AWS Lambda with CDK

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
        if: steps.cache.outputs.cache-hit != 'true'

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: "ASIA4IM3HLT66PJRKHO7"
          aws-secret-access-key: "I82Gs3kHvQEZVWx1aGaAbBQnVw1idArHAyZKWIjl"
          aws-session-token: "IQoJb3JpZ2luX2VjENX//////////wEaDGNhLWNlbnRyYWwtMSJIMEYCIQDmwUkTJ4B+3/+mKSlrPWXUpA+T/01/5ygFDEbEwxdMdgIhAJyaaiOUBi9/FqlM+sLL5eO4tKM5mJIpFfNF2cx9JGLuKvsCCG8QABoMODQyNjc2MDAyMDQ1IgzOlsh4clS3F5KnRioq2AIRPrjOfGUv+ap6pL5xMqQ676TqSnfyBV3jgKq5pUj741AEF/rhWI5gfxjGgVaO8WFjTaXhZMFw1AtznZ8rZpctt7vht76/HPhkfUrSMZ8Q5Bk2AHj/nuvAVBlVVRVIXpeKNUgF63Kg6j54vXTRKSMWEidlSzaKABfQUdTmh33EHeLHHJIu+1CN4VaeEZY7/7N8FTHeM/VmGNvQlcHaZqRcvTgRH51cb5t5nHeVfX2d7CTJjQpoKPPkL05eTw+tuM3HFiQtqEEtVAuLHN/yPY4b7dQ8AmGosMPoWj3xROp6mWiW0mMO9Jkl29vkJI7tAj6UsKAorBd+YIAnDHysr1p2BSe9J39WdlScOwwGip6KaoCC4XXhrxPWTNOeQS5cFmmhHGKFa3f3HayvdFINfNHK5jmRUGPFTi6rhCqMHzmbQTrI6+15/GKY6LgW1T25JdunVKa9FS99ejDqw/C5BjqmAYX8BwohQ4XFQQg07xlWIQ3aGWFMh8XL1YcRgEe9Ir9SLYwYy/2xvtmw8cV9cyfak3MgfAOg7v5/POOpc3ShfptQp8jKso7VPKDmPa9s6b5Ewq9mOcavE+0fhqErNhPESbrVJI5yZ9yLukdx9X2/11mup82DtAVUVBUYbPjHbsTwVUZ2EW5+b0RqDXA4/fiEtqh5Wl26mhfrpju7JwkGg6IL2Lxmp+0="
          aws-region: "ca-central-1"

      - name: CDK Bootstrap
        working-directory: ./my-cdk-app
        run: npx cdk bootstrap || echo "Bootstrap already done"

      - name: Deploy Stack
        working-directory: ./my-cdk-app
        run: npx cdk deploy --require-approval never